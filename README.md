# 🤖📹 Веб-интерфейс управления роботом с USB камерой

## 🆕 Версия 2.1 - Новые возможности
- ✨ **USB камера** - подключение и управление USB веб-камерой
- 📹 **Видеопоток в реальном времени** - MJPEG стрим прямо в браузере
- 📸 **Фотосъемка** - создание фотографий одним кликом
- 🎥 **Видеозапись** - запись видео в формате MP4
- 📁 **Файловый менеджер** - просмотр и управление фото/видео
- ⌨️ **Горячие клавиши** - управление камерой с клавиатуры
- 🎛️ **Настройки качества** - гибкая конфигурация камеры

## 📁 Репозиторий
https://github.com/meshkovQA/Robot.git

## 🚀 Быстрая установка

```bash
# Скачайте и запустите скрипт установки
wget https://raw.githubusercontent.com/meshkovQA/Robot/main/setup.sh
chmod +x setup.sh
./setup.sh

# Перезагрузите систему для применения прав доступа
sudo reboot
```

## 📂 Структура проекта

```
robot_web/
├── run.py               # Главный файл запуска
├── robot/               # Python модули
│   ├── __init__.py      
│   ├── config.py        # Конфигурация системы и камеры
│   ├── i2c_bus.py       # I2C коммуникация
│   ├── controller.py    # Управление движением
│   ├── camera.py        # 🆕 Модуль USB камеры
│   └── api.py          # Flask API с поддержкой камеры
├── templates/
│   └── index.html       # 🆕 HTML с видеоинтерфейсом
├── static/
│   ├── style.css        # 🆕 CSS стили для камеры
│   ├── script.js        # JavaScript управления роботом
│   └── camera.js        # 🆕 JavaScript камеры
├── photos/              # 🆕 Папка для фотографий
├── videos/              # 🆕 Папка для видеозаписей
├── logs/                # Логи системы
├── start.sh            # Запуск сервиса
├── stop.sh             # Остановка сервиса
├── restart.sh          # Перезапуск сервиса
├── logs.sh             # Просмотр логов
├── status.sh           # Диагностика системы
├── update.sh           # Обновление с GitHub
├── test_camera.sh      # 🆕 Тестирование камеры
└── README.md           # Документация
```

## ⚙️ Управление сервисом

### Скрипты управления
- `./start.sh` - запуск веб-сервера
- `./stop.sh` - остановка веб-сервера
- `./restart.sh` - перезапуск веб-сервера
- `./status.sh` - полная диагностика системы
- `./logs.sh` - просмотр логов в реальном времени
- `./update.sh` - обновление файлов с GitHub
- `./test_camera.sh` - **🆕 тестирование USB камеры**

### Systemctl команды
```bash
# Управление сервисом
sudo systemctl start robot-web.service
sudo systemctl stop robot-web.service
sudo systemctl restart robot-web.service
sudo systemctl status robot-web.service

# Автозапуск
sudo systemctl enable robot-web.service   # включить
sudo systemctl disable robot-web.service  # отключить
```

## 🌐 Доступ к интерфейсу

После установки доступны следующие адреса:

```
# Основной веб-интерфейс
http://[IP-адрес-Raspberry-Pi]:5000

# Прямой видеопоток камеры (MJPEG)
http://[IP-адрес-Raspberry-Pi]:5000/camera/stream

# API для разработчиков
http://[IP-адрес-Raspberry-Pi]:5000/api/status
http://[IP-адрес-Raspberry-Pi]:5000/api/camera/status
```

Узнать IP адрес:
```bash
hostname -I
```

## 🎥 Работа с USB камерой

### Поддерживаемые камеры
- Любые USB веб-камеры с поддержкой UVC (USB Video Class)
- Проверенные модели: Logitech C920, C270, Microsoft LifeCam
- Raspberry Pi Camera Module (через USB адаптер)

### Подключение камеры
1. Подключите USB камеру к Raspberry Pi
2. Проверьте обнаружение: `ls /dev/video*`
3. Тестируйте камеру: `./test_camera.sh`
4. Перезапустите сервис: `./restart.sh`

### Возможности камеры
- **📹 Видеопоток в реальном времени** - до 30 FPS
- **📸 Фотосъемка** - качество до 1920x1080
- **🎥 Видеозапись** - MP4 формат с кодеком H.264
- **⚙️ Настройки качества** - яркость, контраст, насыщенность
- **📁 Управление файлами** - просмотр, скачивание, удаление
- **🔄 Автоочистка** - удаление старых файлов

## 🎮 Управление системой

### Веб-интерфейс
- **📹 Видеопоток** - просмотр в реальном времени
- **Ползунки скорости** - точное управление скоростью (-255 до +255)
- **Кнопки движения** - быстрые команды направления
- **Кнопки камеры** - фото, запись, настройки
- **Мониторинг датчиков** - данные в реальном времени
- **Файловый менеджер** - просмотр медиафайлов

### Управление с клавиатуры

#### Движение робота
- **W / ↑** - движение вперед
- **S / ↓** - движение назад  
- **A** - танковый поворот влево
- **D** - танковый поворот вправо
- **Пробел** - остановка
- **Escape** - экстренная остановка

#### 🆕 Управление камерой
- **P** - сделать фотографию
- **R** - начать/остановить видеозапись  
- **F** - обновить список файлов

### Команды робота
```python
# Основные команды движения
move_forward(speed)      # движение вперед
move_backward(speed)     # движение назад
tank_turn_left(speed)    # танковый поворот влево
tank_turn_right(speed)   # танковый поворот вправо
stop()                   # остановка

# 🆕 Команды камеры
take_photo(filename)               # сделать фото
start_recording(filename, duration) # начать запись
stop_recording()                   # остановить запись
```

## 📊 Мониторинг системы

### Датчики робота
- **Передний ультразвуковой датчик** - расстояние до препятствий спереди
- **Задний ультразвуковой датчик** - расстояние до препятствий сзади
- **Цветовая индикация**:
  - 🟢 Зеленый: безопасно (>20см)
  - 🟡 Желтый: внимание (10-20см)  
  - 🔴 Красный: опасно (<10см)

### 🆕 Мониторинг камеры
- **Статус подключения** - онлайн/офлайн индикатор
- **FPS счетчик** - частота кадров в реальном времени
- **Разрешение** - текущие настройки качества
- **Индикатор записи** - статус видеозаписи
- **Счетчик файлов** - количество сохраненных фото/видео

### Индикаторы состояния
- **I2C Соединение** - связь с Arduino
- **Движение** - активность моторов
- **Препятствия** - обнаружение преград
- **🆕 Камера** - статус USB камеры

## 🔧 API интерфейс

### Эндпоинты движения робота
```bash
# Движение
POST /api/move/forward   # движение вперед
POST /api/move/backward  # движение назад
POST /api/turn/left      # поворот влево
POST /api/turn/right     # поворот вправо
POST /api/stop           # остановка
POST /api/emergency_stop # экстренная остановка

# Получение статуса
GET /api/status          # полный статус робота и камеры
GET /api/sensors         # данные датчиков
```

### 🆕 Эндпоинты камеры
```bash
# Управление камерой
GET  /api/camera/status           # статус камеры
POST /api/camera/photo            # сделать фото
POST /api/camera/recording/start  # начать запись
POST /api/camera/recording/stop   # остановить запись
POST /api/camera/restart          # перезапуск камеры
GET  /api/camera/devices          # список доступных камер

# Видеопоток
GET /camera/stream               # MJPEG видеопоток
GET /api/camera/frame            # один кадр в base64

# Файловая система
GET  /api/files/photos           # список фотографий
GET  /api/files/videos           # список видеофайлов
POST /api/files/delete           # удаление файла
```

### Примеры API запросов

```bash
# Сделать фотографию
curl -X POST http://192.168.1.100:5000/api/camera/photo \
  -H "Content-Type: application/json" \
  -d '{"filename": "test_photo.jpg"}'

# Начать видеозапись на 30 секунд
curl -X POST http://192.168.1.100:5000/api/camera/recording/start \
  -H "Content-Type: application/json" \
  -d '{"filename": "test_video.mp4", "duration": 30}'

# Получить статус камеры
curl http://192.168.1.100:5000/api/camera/status

# Движение вперед со скоростью 200
curl -X POST http://192.168.1.100:5000/api/move/forward \
  -H "Content-Type: application/json" \
  -d '{"speed": 200}'
```

## ⚙️ Конфигурация камеры

### Основные настройки (.env файл)
```bash
# Устройство камеры
CAMERA_DEVICE_ID=0              # /dev/video0

# Разрешение и FPS
CAMERA_WIDTH=640                # ширина кадра
CAMERA_HEIGHT=480               # высота кадра
CAMERA_FPS=30                   # частота кадров

# Качество изображения (1-100)
CAMERA_QUALITY=80               # качество фото
CAMERA_STREAM_QUALITY=60        # качество веб-стрима
CAMERA_STREAM_FPS=15            # FPS веб-стрима

# Настройки изображения (0-100)
CAMERA_BRIGHTNESS=50            # яркость
CAMERA_CONTRAST=50              # контраст  
CAMERA_SATURATION=50            # насыщенность

# Пути сохранения
CAMERA_SAVE_PATH=/home/pi/robot_web/photos
CAMERA_VIDEO_PATH=/home/pi/robot_web/videos

# Ограничения
MAX_PHOTOS=100                  # максимум фотографий
MAX_VIDEOS=20                   # максимум видеофайлов
AUTO_CLEANUP_DAYS=7             # автоочистка через N дней
```

### Предустановки качества
```bash
# Выберите предустановку
CAMERA_PRESET=medium

# Доступные варианты:
# low    - 320x240,  15fps, качество 50%
# medium - 640x480,  30fps, качество 70%  
# high   - 1280x720, 30fps, качество 90%
# ultra  - 1920x1080,30fps, качество 95%
```

## 🛡️ Системы безопасности

### Встроенные механизмы
- **Автоматическая остановка** при обнаружении препятствий
- **Тайм-аут команд** - остановка через 3 секунды без команд
- **Экстренная остановка** при потере веб-соединения
- **Предупреждения** о закрытии браузера во время движения
- **🆕 Автостоп записи** при переполнении диска
- **🆕 Ограничения размера файлов** для предотвращения переполнения

### Безопасность камеры
- **Автоматическое отключение** при ошибках камеры
- **Ограничение длительности записи** - максимум задается в настройках
- **Контроль доступа к файлам** - только в разрешенных директориях
- **Автоочистка старых файлов** - предотвращение переполнения диска

## 🔍 Устранение неполадок

### Диагностика проблем
```bash
# Полная диагностика системы
./status.sh

# Тестирование камеры
./test_camera.sh

# Просмотр логов
./logs.sh

# Проверка USB камер
ls /dev/video*
lsusb | grep -i camera

# Проверка I2C соединения
sudo i2cdetect -y 1
```

### Частые проблемы с камерой

#### USB камера не обнаружена
```bash
# Проверить подключение
lsusb | grep -i camera
ls /dev/video*

# Проверить права доступа
groups $USER | grep video

# Добавить пользователя в группу video
sudo usermod -a -G video $USER
sudo reboot
```

#### Низкое качество видео
```bash
# Проверить возможности камеры
v4l2-ctl --device=/dev/video0 --list-formats-ext

# Настроить разрешение в .env
CAMERA_WIDTH=1280
CAMERA_HEIGHT=720
CAMERA_QUALITY=90

# Перезапустить сервис
./restart.sh
```

#### Видеопоток не загружается
```bash
# Проверить занятость камеры
sudo lsof /dev/video0

# Перезапустить камеру
curl -X POST http://localhost:5000/api/camera/restart

# Проверить логи
./logs.sh | grep camera
```

#### Веб-интерфейс недоступен с других устройств
```bash
# Проверить брандмауэр
sudo ufw status
sudo ufw allow 5000/tcp

# Перезапустить сервер
./restart.sh
```

#### Arduino не отвечает на I2C
```bash
# Проверить I2C устройства
sudo i2cdetect -y 1

# Должен показать устройство на адресе 0x08
# Если нет - проверить подключение и Arduino код
```

## 🛠️ Технические требования

### Аппаратное обеспечение
- **Raspberry Pi 4** (рекомендуется 4GB RAM)
- **Arduino Uno** с загруженным кодом управления
- **I2C соединение** между RPi и Arduino
- **Ультразвуковые датчики HC-SR04** (2 шт.)
- **L298N драйверы моторов**
- **🆕 USB веб-камера** с поддержкой UVC
- **🆕 Быстрая SD карта** (для записи видео)

### Программное обеспечение
- **Raspberry Pi OS** (Bullseye или новее)
- **Python 3.8+**
- **Flask веб-фреймворк**
- **smbus2** для I2C коммуникации
- **🆕 OpenCV 4.5+** для работы с камерой
- **🆕 v4l-utils** для настройки USB камер

### 🆕 USB камера требования
- **Поддержка UVC** (USB Video Class)
- **Разрешение**: минимум 640x480, рекомендуется 1280x720
- **Совместимость**: проверенные Logitech C920/C270, Microsoft LifeCam
- **Питание**: не более 500mA (стандарт USB 2.0)

### Поддерживаемые браузеры
- Chrome/Chromium (рекомендуется)
- Firefox
- Safari (iOS)
- Mobile Chrome (Android)

## 🔄 Обновление проекта

Когда вы обновили файлы в GitHub репозитории:

```bash
cd /home/pi/robot_web
./update.sh
```

Скрипт `update.sh` автоматически:
- ✅ Создаст бэкапы текущих файлов
- ✅ Скачает новые версии с GitHub
- ✅ Проверит синтаксис Python
- ✅ Протестирует модуль камеры
- ✅ Безопасно перезапустит сервер
- ✅ Проверит что все работает

## 📚 Дополнительная информация

### 🆕 Интеграция камеры с движением робота

Система поддерживает автоматические функции:

```bash
# Автоматическое фото при препятствии
PHOTO_ON_OBSTACLE=true

# Автоматическая запись при движении
RECORD_ON_ROBOT_MOVE=true

# Сохранение кадра при экстренной остановке
SAVE_FRAME_ON_EMERGENCY=true
```

### Архитектура системы v2.1
- **Flask сервер** на Raspberry Pi обрабатывает веб-запросы
- **I2C протокол** для связи с Arduino
- **Arduino** выполняет низкоуровневое управление моторами и датчиков
- **🆕 USB камера** через OpenCV для видеозахвата
- **🆕 Многопоточность** для параллельной обработки видео и управления
- **Веб-интерфейс** предоставляет единое управление всеми системами

### 🆕 Производительность и оптимизация

**Настройки производительности:**
```bash
# Количество потоков для камеры
CAMERA_THREADS=2

# Размер буфера видео
VIDEO_BUFFER_SIZE=1

# FPS для веб-стрима (экономия трафика)
CAMERA_STREAM_FPS=15

# Таймауты
CAMERA_INIT_TIMEOUT=10
CAMERA_CAPTURE_TIMEOUT=5
```

**Рекомендации по оптимизации:**
- Используйте быструю SD карту (Class 10, U3)
- Для высокого качества видео нужна Raspberry Pi 4 с 4GB RAM
- Ограничивайте одновременное количество подключений к видеопотоку
- Регулярно очищайте старые медиафайлы

### Расширение функционала

Система легко расширяется:
- **🆕 Детекция движения** - автоматическая запись при движении в кадре
- **🆕 Распознавание объектов** - интеграция с TensorFlow/OpenCV
- **Добавление новых датчиков** через I2C
- **Интеграция с системами умного дома** через MQTT
- **API для внешних приложений** - JSON REST API
- **🆕 Стриминг на YouTube/Twitch** - трансляция видео в реальном времени

### 🆕 Планируемые функции v2.2

- **🎯 Автоматическое следование за объектами**
- **🗺️ SLAM навигация с камерой**
- **🤖 AI ассистент с голосовыми командами**
- **📱 Мобильное приложение**
- **☁️ Облачное хранение медиафайлов**
- **🎮 VR/AR управление**

## 🐛 Известные ограничения

### Камера
- Одновременно может работать только одна USB камера
- Максимальное разрешение зависит от производительности USB порта
- Некоторые камеры могут требовать дополнительные драйверы
- Видеозапись в формате MP4 может быть ресурсоемкой

### Система
- I2C может периодически терять соединение при высокой нагрузке
- Веб-интерфейс оптимизирован для одного пользователя
- Большие видеофайлы могут замедлять интерфейс

### Производительность
- При записи видео 1080p возможны пропуски кадров
- Одновременная запись видео и быстрое движение может вызывать задержки
- Рекомендуется не более 3-5 одновременных подключений к видеопотоку

## 🤝 Вклад в проект

Приветствуются любые улучшения:

1. **Fork** репозитория
2. Создайте **feature branch** (`git checkout -b feature/amazing-feature`)
3. **Commit** изменения (`git commit -m 'Add amazing feature'`)
4. **Push** в branch (`git push origin feature/amazing-feature`)
5. Создайте **Pull Request**

### Приоритетные направления для разработки
- 🎯 Улучшение алгоритмов компьютерного зрения
- 🚀 Оптимизация производительности видеопотока
- 📱 Мобильная версия интерфейса
- 🤖 Интеграция машинного обучения
- 🌐 Поддержка нескольких языков

## 📞 Поддержка

При возникновении проблем:

1. **Проверьте диагностику**: `./status.sh`
2. **Тестируйте камеру**: `./test_camera.sh`
3. **Просмотрите логи**: `./logs.sh`
4. **Создайте Issue** в GitHub с подробным описанием
5. **Приложите вывод** команд диагностики

## 📄 Лицензия

Проект распространяется под MIT License. Подробности в файле `LICENSE`.

## 🙏 Благодарности

- **OpenCV** - за мощную библиотеку компьютерного зрения
- **Flask** - за простой и гибкий веб-фреймворк
- **Raspberry Pi Foundation** - за отличную платформу
- **Arduino** - за надежную платформу для управления
- **Сообщество разработчиков** - за тестирование и обратную связь

---

**🤖✨ Удачного управления роботом с камерой! ✨📹**

*Версия документации: 2.1*  
*Последнее обновление: 2024*

### 🔗 Полезные ссылки

- **GitHub репозиторий**: https://github.com/meshkovQA/Robot
- **Документация OpenCV**: https://docs.opencv.org/
- **Raspberry Pi документация**: https://www.raspberrypi.org/documentation/
- **Flask документация**: https://flask.palletsprojects.com/
- **Arduino документация**: https://www.arduino.cc/reference/